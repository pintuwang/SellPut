<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sell Put Analyzer Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--accent:#38bdf8;--green:#10b981;--red:#ef4444;--amber:#f59e0b}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif}
    body{background:var(--bg);color:#e2e8f0;line-height:1.6;padding:2rem}
    h1{text-align:center;margin-bottom:1rem}
    .grid{display:grid;gap:2rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .card{background:var(--card);padding:1.5rem;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    label{display:block;margin:.5rem 0 .25rem;font-weight:600;font-size:.9rem}
    input{width:100%;padding:.6rem .8rem;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#fff}
    button{width:100%;margin-top:1rem;padding:.75rem;border:none;border-radius:6px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:hover{filter:brightness(1.15)}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:.6rem .5rem;border-bottom:1px solid #334155}
    .metric-value{font-weight:700;color:var(--accent)}
    .success-rate{font-size:2rem;text-align:center;margin:1rem 0}
    .risk-low{color:var(--green)}.risk-medium{color:var(--amber)}.risk-high{color:var(--red)}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Sell Put Analyzer <span style="font-size:.5em">(Yahoo Finance Live)</span></h1>
  <div class="grid">
    <div class="card">
      <form id="form">
        <label>Stock Symbol<input id="sym" placeholder="AAPL" required></label>
        <label>Strike ($)<input id="k" type="number" step="0.01" required></label>
        <label>Expiry<input id="exp" type="date" required></label>
        <label>Sell Price ($)<input id="pr" type="number" step="0.01" required></label>
        <button type="submit">Analyze</button>
        <!-- progress bar & status -->
  <div id="progressBox" class="hidden" style="margin-top:.8rem">
    <div style="background:#334155;height:6px;border-radius:3px;overflow:hidden">
    <div id="progress" style="height:100%;background:var(--accent);width:0;transition:width .25s"></div>
  </div>
  <small id="status" style="color:#94a3b8">Ready</small>
</div>

        
      </form>
      <p id="load" class="hidden">Loadingâ€¦</p>
      <p id="err" style="color:var(--red)"></p>
    </div>

    <div class="card hidden" id="res">
      <div class="success-rate">Prob of Success <span id="prob">--</span>%</div>
      <div class="metric">Position Delta <span id="delta" class="metric-value">--</span></div>
      <div class="metric">% OTM <span id="otm" class="metric-value">--</span>%</div>
      <div class="metric">Premium <span id="prem" class="metric-value">--</span></div>
      <div class="metric">Max Profit <span id="maxp" class="metric-value">--</span></div>
      <div class="metric">Breakeven <span id="be" class="metric-value">--</span></div>
      <div class="metric">Days to Exp <span id="dte" class="metric-value">--</span></div>
      <div class="metric">Annual Ret <span id="aret" class="metric-value">--</span>%</div>
      <div class="metric">Return/Risk <span id="ror" class="metric-value">--</span>%</div>
      <div class="metric">Expected Val <span id="ev" class="metric-value">--</span></div>
      <!-- NEW: Daily earning -->
      <div class="metric">Daily Earning <span id="dailyEarn" class="metric-value">--</span></div>

      <!-- NEW: IV with source -->
      
      <div class="metric">
  IV
  <span id="ivVal" class="metric-value">--</span>
  <small id="ivSrc" style="color:#94a3b8"></small>
  <!-- editable override appears only when assumed -->
  <span id="ivEdit" class="hidden" style="margin-left:0.5rem">
    <input id="ivInput" type="number" step="0.1" min="0" max="500" style="width:4.5rem;text-align:right;background:#0f172a;border:1px solid #334155;color:#fff;border-radius:4px;padding:0.2rem 0.3rem;" title="% per year"> %
    <button id="ivUpdate" class="iv-btn" style="margin-left:0.3rem;padding:0.2rem 0.5rem;font-size:0.75rem;background:var(--accent);border:none;border-radius:4px;color:#fff;cursor:pointer;">Update</button>
  </span>
</div>
      <div class="metric">IV Percentile (1 yr) <span id="ivPct" class="metric-value">--</span></div>
      <div class="metric">Vol Premium vs 30 d HV <span id="volPrem" class="metric-value">--</span>%</div>
      <div class="metric">Risk Level <span id="risk" class="metric-value">--</span></div>
      <div id="earn" class="hidden" style="margin-top:1rem;color:var(--amber)"></div>
    </div>
  </div>

  <!-- ============  REPLACE THE OLD SCRIPT BLOCK ENTIRELY  ============ -->
<script>
let lastStockPrice = 0; // for IV override

const $ = q => document.querySelector(q);
const fmt = (n, d = 2) => (+n || 0).toFixed(d);

/* ----------  proxy rotator  ---------- */
const proxies = ['https://corsproxy.io/?', 'https://api.codetabs.com/v1/proxy?quest='];
async function fetchJSON(url) {
  for (const p of proxies) { try { const r = await fetch(p + encodeURIComponent(url)); if (r.ok) return await r.json(); } catch {} }
  return null;
}

/* ----------  new: IV percentile + 30 d HV  ---------- */
async function getIVMetrics(sym) {
  // Schwab-style 1-year IV percentile + 30-day historical vol
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1y&interval=1d`;
  const data = await fetchJSON(url);
  if (!data?.chart?.result?.[0]) return { ivPct: null, hv30: null };
  const quotes = data.chart.result[0].indicators.quote[0];
  const closes = quotes.close.filter(c => c);           // remove nulls
  if (closes.length < 30) return { ivPct: null, hv30: null };

  // 30-day historical volatility (annualised)
  let sumLog = 0, sumSq = 0;
  for (let i = 1; i < 30; i++) {
    const logRet = Math.log(closes[i] / closes[i - 1]);
    sumLog += logRet;
    sumSq += logRet * logRet;
  }
  const avgLog = sumLog / 29;
  const varDaily = sumSq / 29 - avgLog * avgLog;
  const hv30 = Math.sqrt(varDaily * 252) * 100; // annualised %

  // IV percentile: count how many of the last 252 days had **close-to-close HV** below todayâ€™s 30-day HV
  let daysBelow = 0, totalDays = 0;
  for (let i = 30; i < closes.length; i++) {
    let sum = 0, sq = 0;
    for (let j = i - 29; j < i; j++) {
      const lr = Math.log(closes[j + 1] / closes[j]);
      sum += lr; sq += lr * lr;
    }
    const avg = sum / 29; const varD = sq / 29 - avg * avg;
    const hv = Math.sqrt(varD * 252) * 100;
    if (hv < hv30) daysBelow++;
    totalDays++;
  }
  const ivPct = totalDays ? Math.round((daysBelow / totalDays) * 100) : null;
  return { ivPct, hv30 };
}

/* ----------  Yahoo quote & chain  ---------- */
async function getQuote(sym) {
  const data = await fetchJSON(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=1mo`);
  return data?.chart?.result?.[0];
}
async function getOpts(sym) {
  const data = await fetchJSON(`https://query1.finance.yahoo.com/v7/finance/options/${sym}`);
  return data?.optionChain?.result?.[0];
}

/* ----------  main flow  ---------- */
$('#form').addEventListener('submit', async e => {
  e.preventDefault();
  $('#err').textContent = ''; $('#res').classList.add('hidden');
  const statusEl = $('#status'), progressBar = $('#progress'), progressBox = $('#progressBox');
  function setStatus(txt, pct = 0) { if (statusEl) statusEl.textContent = txt; if (progressBar) progressBar.style.width = pct + '%'; }
  function hideProgress() { progressBox.classList.add('hidden'); } function showProgress() { progressBox.classList.remove('hidden'); }
  showProgress(); setStatus('Startingâ€¦', 0);

  const sym = $('#sym').value.toUpperCase();
  const k = parseFloat($('#k').value);
  const sell = parseFloat($('#pr').value);
  const exp = new Date($('#exp').value);
  const now = new Date();
  const days = Math.ceil((exp - now) / 864e5);
  if (days <= 0) { $('#err').textContent = 'Expiry must be in the future'; hideProgress(); return; }

  const quote = await getQuote(sym);
  if (!quote) { $('#err').textContent = 'Symbol not found'; hideProgress(); return; }
  const S = quote.meta.regularMarketPrice;
  window.lastStockPrice = S; // for IV override

  const opts = await getOpts(sym);
  let iv = 0.25, src = 'Assumed 25%';
  if (opts?.optionChain?.result?.[0]) {
    const chain = opts.optionChain.result[0].options[0]?.puts.find(p => fmt(p.strike) === fmt(k));
    if (chain) { iv = chain.impliedVolatility * 0.01; src = 'Yahoo'; }
  }
  if (!iv || iv <= 0 || iv > 5) { iv = await getIV_Tradier(sym, k); src = iv ? 'Tradier' : src; }
  if (!iv || iv <= 0 || iv > 5) iv = 0.25;

  /* ----  new metrics  ---- */
  const { ivPct, hv30 } = await getIVMetrics(sym);
  let volPrem = null;
  if (hv30 && iv) volPrem = fmt((iv * 100 - hv30) / hv30 * 100, 1);

  setStatus('Crunching numbersâ€¦', 90);
  try {
    const T = days / 365, r = 0.045;
    const d1 = (Math.log(S / k) + (r + 0.5 * iv * iv) * T) / (iv * Math.sqrt(T));
    const d2 = d1 - iv * Math.sqrt(T);
    function nd(x) { const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const sign = x >= 0 ? 1 : -1, b = Math.abs(x) / Math.sqrt(2), t = 1 / (1 + p * b);
      return 0.5 * (1 + sign * (1 - (((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-b * b)))); }
    const putDelta = nd(d1) - 1, probOTM = nd(d2);
    const prem = sell * 100, maxLoss = (k - sell) * 100, be = k - sell, ror = (prem / maxLoss) * 100, ann = ror * (365 / days);
    const ev = probOTM * prem - (1 - probOTM) * maxLoss, daily = prem / days;
    const riskLvl = probOTM > 0.8 ? 'Low' : probOTM > 0.65 ? 'Medium' : 'High';

    setStatus('Done!', 100);
    $('#prob').textContent = fmt(probOTM * 100, 1); $('#delta').textContent = fmt(-putDelta, 3);
    $('#otm').textContent = fmt(((S - k) / S) * 100, 1); $('#prem').textContent = '$' + fmt(prem);
    $('#maxp').textContent = '$' + fmt(prem); $('#be').textContent = '$' + fmt(be); $('#dte').textContent = days;
    $('#aret').textContent = fmt(ann, 1); $('#ror').textContent = fmt(ror, 1); $('#ev').textContent = '$' + fmt(ev);
    $('#dailyEarn').textContent = '$' + fmt(daily, 2); $('#ivVal').textContent = fmt(iv * 100, 1) + '%';
    $('#ivSrc').textContent = '(source: ' + src + ')';

    /* =====  IV override logic  ===== */
   if (src === 'Assumed 25%') {
    $('#ivEdit').classList.remove('hidden');
    $('#ivInput').value = fmt(iv * 100, 1);
    // attach handler **after** element exists
    $('#ivUpdate').onclick = function () {
    const userIV = parseFloat($('#ivInput').value);
    if (userIV > 0 && userIV <= 500) reCalculateWithIV(userIV / 100);
      };
    } else {
  $('#ivEdit').classList.add('hidden');
    }
/* =============================== */

    
    $('#ivPct').textContent = ivPct !== null ? ivPct + '%' : '--';
    $('#volPrem').textContent = volPrem !== null ? volPrem + '%' : '--';
    /* =====  IV override logic  ===== */
    if (src === 'Assumed 25%') {
      $('#ivEdit').classList.remove('hidden');
      $('#ivInput').value = fmt(iv * 100, 1);
      $('#ivUpdate').onclick = () => {
        const userIV = parseFloat($('#ivInput').value);
        if (userIV > 0 && userIV <= 500) reCalculateWithIV(userIV / 100);
      };
    } else { $('#ivEdit').classList.add('hidden'); }
    $('#risk').textContent = riskLvl; $('#risk').className = 'metric-value risk-' + riskLvl.toLowerCase();
    hideProgress(); $('#res').classList.remove('hidden');
  } catch (e) {
    console.error(e); $('#err').textContent = 'Math / network error â€“ check inputs or try again.';
    hideProgress();
  }
});

/* ----------  re-calc with user IV  ---------- */
function reCalculateWithIV(newIV) {
  hideProgress(); setStatus('Recalculatingâ€¦', 50);
  try {
    const k = parseFloat($('#k').value), sell = parseFloat($('#pr').value), exp = new Date($('#exp').value);
    const now = new Date(), days = Math.ceil((exp - now) / 864e5);
    const S = window.lastStockPrice, T = days / 365, r = 0.045, prem = sell * 100, maxLoss = (k - sell) * 100;
    const d1 = (Math.log(S / k) + (r + 0.5 * newIV * newIV) * T) / (newIV * Math.sqrt(T));
    const d2 = d1 - newIV * Math.sqrt(T);
    function nd(x) { const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const sign = x >= 0 ? 1 : -1, b = Math.abs(x) / Math.sqrt(2), t = 1 / (1 + p * b);
      return 0.5 * (1 + sign * (1 - (((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-b * b)))); }
    const putDelta = nd(d1) - 1, probOTM = nd(d2);
    const ror = (prem / maxLoss) * 100, ann = ror * (365 / days), ev = probOTM * prem - (1 - probOTM) * maxLoss, daily = prem / days;
    const riskLvl = probOTM > 0.8 ? 'Low' : probOTM > 0.65 ? 'Medium' : 'High';
    setStatus('Done!', 100);
    $('#prob').textContent = fmt(probOTM * 100, 1); $('#delta').textContent = fmt(-putDelta, 3);
    $('#otm').textContent = fmt(((S - k) / S) * 100, 1); $('#ev').textContent = '$' + fmt(ev);
    $('#aret').textContent = fmt(ann, 1); $('#ror').textContent = fmt(ror, 1); $('#dailyEarn').textContent = '$' + fmt(daily, 2);
    $('#ivVal').textContent = fmt(newIV * 100, 1) + '%'; $('#ivSrc').textContent = '(user override)';
    $('#risk').textContent = riskLvl; $('#risk').className = 'metric-value risk-' + riskLvl.toLowerCase();
    hideProgress();
  } catch (e) {
    console.error(e); $('#err').textContent = 'Override error: ' + e.message;
    hideProgress();
  }
}
</script>
<!-- ============  END NEW SCRIPT  ============ -->
 </body>
</html>
