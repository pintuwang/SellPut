<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sell Put Analyzer Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--accent:#38bdf8;--green:#10b981;--red:#ef4444;--amber:#f59e0b}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif}
    body{background:var(--bg);color:#e2e8f0;line-height:1.6;padding:2rem}
    h1{text-align:center;margin-bottom:1rem}
    .grid{display:grid;gap:2rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .card{background:var(--card);padding:1.5rem;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    label{display:block;margin:.5rem 0 .25rem;font-weight:600;font-size:.9rem}
    input{width:100%;padding:.6rem .8rem;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#fff}
    button{width:100%;margin-top:1rem;padding:.75rem;border:none;border-radius:6px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:hover{filter:brightness(1.15)}
    .metric{display:flex;justify-content:space-between;align-items:center;padding:.6rem .5rem;border-bottom:1px solid #334155}
    .metric-value{font-weight:700;color:var(--accent)}
    .success-rate{font-size:2rem;text-align:center;margin:1rem 0}
    .risk-low{color:var(--green)}.risk-medium{color:var(--amber)}.risk-high{color:var(--red)}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Sell Put Analyzer <span style="font-size:.5em">(Yahoo Finance Live)</span></h1>
  <div class="grid">
    <div class="card">
      <form id="form">
        <label>Stock Symbol<input id="sym" placeholder="AAPL" required></label>
        <label>Strike ($)<input id="k" type="number" step="0.01" required></label>
        <label>Expiry<input id="exp" type="date" required></label>
        <label>Sell Price ($)<input id="pr" type="number" step="0.01" required></label>
        <button type="submit">Analyze</button>
      </form>
      <p id="load" class="hidden">Loadingâ€¦</p>
      <p id="err" style="color:var(--red)"></p>
    </div>

    <div class="card hidden" id="res">
      <div class="success-rate">Prob of Success <span id="prob">--</span>%</div>
      <div class="metric">Position Delta <span id="delta" class="metric-value">--</span></div>
      <div class="metric">% OTM <span id="otm" class="metric-value">--</span>%</div>
      <div class="metric">Premium <span id="prem" class="metric-value">--</span></div>
      <div class="metric">Max Profit <span id="maxp" class="metric-value">--</span></div>
      <div class="metric">Breakeven <span id="be" class="metric-value">--</span></div>
      <div class="metric">Days to Exp <span id="dte" class="metric-value">--</span></div>
      <div class="metric">Annual Ret <span id="aret" class="metric-value">--</span>%</div>
      <div class="metric">Return/Risk <span id="ror" class="metric-value">--</span>%</div>
      <div class="metric">Expected Val <span id="ev" class="metric-value">--</span></div>
      <div class="metric">Risk Level <span id="risk" class="metric-value">--</span></div>
      <div id="earn" class="hidden" style="margin-top:1rem;color:var(--amber)"></div>
    </div>
  </div>

  <script>
    const $ = q => document.querySelector(q);
    const fmt = (n, d = 2) => (+n || 0).toFixed(d);
    const yahoo = async (url) => {
      const proxy = 'https://api.allorigins.win/raw?url=';
      return fetch(proxy + encodeURIComponent(url))
        .then(r => r.json())
        .catch(() => null);
    };
    const getQuote = async (s) => {
      const data = await yahoo(`https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=1mo`);
      return data?.chart?.result?.[0];
    };
    const getOpts = async (s) => {
      const data = await yahoo(`https://query1.finance.yahoo.com/v7/finance/options/${s}`);
      return data?.optionChain?.result?.[0];
    };

    $('#form').addEventListener('submit', async e => {
      e.preventDefault();
      $('#load').classList.remove('hidden');
      $('#err').textContent = '';
      $('#res').classList.add('hidden');
      const sym = $('#sym').value.toUpperCase();
      const k = parseFloat($('#k').value);
      const sell = parseFloat($('#pr').value);
      const exp = new Date($('#exp').value);
      const now = new Date();
      const days = Math.ceil((exp - now) / 864e5);
      if (days <= 0) return $('#err').textContent = 'Expiry must be in the future';

      const quote = await getQuote(sym);
      if (!quote) return $('#err').textContent = 'Symbol not found';
      const S = quote.meta.regularMarketPrice;
      const r = 0.045; // risk-free
      const opts = await getOpts(sym);
      let iv = 0.25; // fallback
      if (opts) {
        const chain = opts.options[0]?.puts.find(p => fmt(p.strike) === fmt(k));
        iv = (chain?.impliedVolatility || iv) * 0.01;
      }
      const T = days / 365;
      const d1 = (Math.log(S / k) + (r + 0.5 * iv * iv) * T) / (iv * Math.sqrt(T));
      const d2 = d1 - iv * Math.sqrt(T);
      const nd = x => 0.5 * (1 + Math.erf(x / Math.SQRT2));
      const putDelta = nd(d1) - 1;
      const probOTM = nd(d2);
      const prem = sell * 100;
      const maxLoss = (k - sell) * 100;
      const be = k - sell;
      const ror = (prem / maxLoss) * 100;
      const ann = ror * (365 / days);
      const ev = probOTM * prem - (1 - probOTM) * maxLoss;
      const risk = probOTM > 0.8 ? 'Low' : probOTM > 0.65 ? 'Medium' : 'High';

      $('#prob').textContent = fmt(probOTM * 100, 1);
      $('#delta').textContent = fmt(-putDelta, 3); // seller delta
      $('#otm').textContent = fmt(((S - k) / S) * 100, 1);
      $('#prem').textContent = '$' + fmt(prem);
      $('#maxp').textContent = '$' + fmt(prem);
      $('#be').textContent = '$' + fmt(be);
      $('#dte').textContent = days;
      $('#aret').textContent = fmt(ann, 1);
      $('#ror').textContent = fmt(ror, 1);
      $('#ev').textContent = '$' + fmt(ev);
      $('#risk').textContent = risk;
      $('#risk').className = 'metric-value risk-' + risk.toLowerCase();
      $('#earn').classList.add('hidden');
      if (opts) {
        const earn = opts.options[0]?.expirationDates.map(e => new Date(e * 1000));
        const closest = earn?.find(d => d > now && d < exp);
        if (closest) $('#earn').textContent = `âš ï¸ Earnings expected around ${closest.toLocaleDateString()}`;
        $('#earn').classList.remove('hidden');
      }
      $('#load').classList.add('hidden');
      $('#res').classList.remove('hidden');
    });
  </script>
</body>
</html>
